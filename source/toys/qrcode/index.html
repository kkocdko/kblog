<!DOCTYPE html>

<head>
  <base href="/toy/qrcode/" />
  <script
    :name="QR Code"
    :description="Generate QR Code and allow select mask function."
    :version="0.1.7"
    src="../veps.js"
  ></script>
  <script src="https://registry.npmmirror.com/qrcode-generator/1.4.4/files/qrcode.js"></script>
</head>

<style>
  svg {
    width: 80vmin;
    max-width: 300px;
    height: 80vmin;
    max-height: 300px;
  }
  body > * {
    display: block;
    width: 80vmin;
    max-width: 300px;
    margin: 10px auto 0;
  }
  div ~ * {
    padding: 4px 8px;
    border: 1px solid #888;
  }
</style>

<body>
  <div id="$o"></div>
  <select id="$level">
    <option value="L" selected>Level L (7%)</option>
    <option value="M">Level M (15%)</option>
    <option value="Q">Level Q (25%)</option>
    <option value="H">Level H (30%)</option>
  </select>
  <input id="$mask" placeholder="Custom mask (0-7)" type="number" disabled />
  <input id="$i" placeholder="Input content here" />
</body>

<script>
  $i.value = location.origin;
  $level.onchange = $i.oninput = () => {
    const qr = qrcode(0, $level.value);
    qr.addData($i.value);
    qr.make();
    $o.innerHTML = qr.createSvgTag(1, 1); // (block, margin)
  };
  $i.oninput();
  (async () => {
    const url = document.querySelector('[src$="qrcode.js"]').src;
    const src = await (await fetch(url)).text();
    const idx = src.indexOf("pattern;");
    eval(src.slice(0, idx) + "window.qrmask??" + src.slice(idx));
    window.qrcode = qrcode;
    $mask.removeAttribute("disabled");
  })();
  $mask.oninput = () => {
    window.qrmask = $mask.value === "" ? undefined : +$mask.value;
    if (qrmask < 0 || qrmask > 7 || $mask.value.includes(".")) {
      qrmask = undefined;
      return alert("Custom mask allows only 0-7");
    }
    $i.oninput();
  };
</script>
