<!DOCTYPE html>

<head>
  <base href="/toy/qrcode/" />
  <script
    :name="QR Code"
    :description="Generate QR Code and allow select mask function."
    :version="0.1.10"
    src="../veps.js"
  ></script>
  <script src="//registry.npmmirror.com/qrcode-generator/1.4.4/files/qrcode.js"></script>
</head>

<style>
  svg {
    width: 80vmin;
    max-width: 300px;
    height: 80vmin;
    max-height: 300px;
  }
  body > * {
    display: block;
    width: 80vmin;
    max-width: 300px;
    margin: 10px auto 0;
  }
  div ~ * {
    padding: 4px 8px;
    border: 1px solid #888;
  }
</style>

<body>
  <div id="$o"></div>
  <select id="$level">
    <option value="L" selected>Level L (7%)</option>
    <option value="M">Level M (15%)</option>
    <option value="Q">Level Q (25%)</option>
    <option value="H">Level H (30%)</option>
  </select>
  <select id="$mask" disabled>
    <option value="-1" selected>Auto mask</option>
    <option>0</option>
    <option>1</option>
    <option>2</option>
    <option>3</option>
    <option>4</option>
    <option>5</option>
    <option>6</option>
    <option>7</option>
  </select>
  <input id="$i" placeholder="QRCode content here" />
  <!--
  <button>Decode from image</button>
  <input id="$decI" type="file" autocomplete="off" />
  <img id="$decP" style="display: none" />
  <input id="$decO" />
  -->
</body>

<script>
  $i.value = location.origin;
  const refresh = () => {
    window.qrmask = $mask.value === "-1" ? undefined : +$mask.value;
    const qr = qrcode(0, $level.value);
    qr.addData($i.value);
    qr.make();
    $o.innerHTML = qr.createSvgTag(1, 1); // (block, margin)
  };
  $level.onchange = $mask.onchange = $i.oninput = refresh;
  refresh();
  setTimeout(async () => {
    const url = document.querySelector('[src$="qrcode.js"]').src;
    const src = await (await fetch(url)).text();
    const idx = src.indexOf("pattern;");
    eval(src.slice(0, idx) + "window.qrmask??" + src.slice(idx));
    window.qrcode = qrcode;
    $mask.removeAttribute("disabled");
  }, 100);
</script>

<!--
<script src="https://registry.npmmirror.com/@techstark/opencv-js/4.8.0-release.10/files/dist/opencv.js"></script>

<script>
  // https://docs.opencv.org/4.8.0/d0/d84/tutorial_js_usage.html
  $decI.onchange = async (e) => {
    $decP.src = URL.createObjectURL(e.target.files[0]);
    await new Promise((r) => ($decP.onload = r));
    let mat = cv.imread($decP);
    let detector = new cv.QRCodeDetector();
    let data = detector.detectAndDecode(mat);
    window.qrdata = data;
    console.log(data);
  };
</script>
-->
