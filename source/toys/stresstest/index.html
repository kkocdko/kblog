<!DOCTYPE html>

<head>
  <base href="/toy/stresstest/" />
  <script>
    __VEPS_CFG__ = {
      name: "Stress Test",
      description: "CPU and GPU stress test.",
      background: "rgb(248, 249, 250)",
      themeColor: "rgb(51, 103, 214)",
      icon: `-6 -6 60 60 | <path d="M27 1.34s1.48 5.3 1.48 9.6c0 4.12-2.7 7.47-6.83 7.47s-7.25-3.34-7.25-7.47l.05-.72C10.43 15.03 8 21.23 8 28c0 8.84 7.16 16 16 16s16-7.16 16-16c0-10.79-5.19-20.41-13-26.66zM23.42 38c-3.56 0-6.45-2.81-6.45-6.28 0-3.25 2.09-5.53 5.63-6.24s7.2-2.41 9.23-5.15c.78 2.58 1.19 5.3 1.19 8.07 0 5.29-4.3 9.6-9.6 9.6z"/>`,
      version: "0.0.1",
    };
  </script>
  <script veps-main src="../veps.js"></script>
</head>

<veps-deps>
  <link rel="stylesheet" href="../misc/tmd.css" />
</veps-deps>

<style></style>

<body style="width: fit-content; min-width: 0">
  <header>Stress Test</header>
  <figure style="grid: none / 60px 60px; text-align: center">
    <label>CPU<input id="$cpu" type="checkbox" checked /></label>
    <label>GPU<input id="$gpu" type="checkbox" /></label>
    <button id="$toggle" style="grid-column: 1 / 3">
      Run
      <progress
        _none
        style="padding: 5px; margin-left: 5px; border-width: 2px"
      ></progress>
    </button>
  </figure>
</body>

<script>
  "use strict";

  const workers = [];

  const addWorker = (workerFn) => {
    const str = `(${workerFn.toString()})()`;
    const blob = new Blob([str]);
    const url = URL.createObjectURL(blob);
    workers.push(new Worker(url));
  };

  $toggle.onclick = () => {
    if ($toggle.lastElementChild.toggleAttribute("_none")) {
      for (const worker of workers) worker.terminate();
      workers.length = 0;
      return;
    }
    if (!$cpu.checked && !$gpu.checked) {
      alert("You should check at least one item");
      return;
    }
    if ($cpu.checked) {
      const workerFn = () => {
        while (1);
      };
      const cpuCount = navigator.hardwareConcurrency;
      for (let i = 0; i < cpuCount; i++) addWorker(workerFn);
    }
    if ($gpu.checked) {
      alert("GPU Stress Test is still developing...");
      // workersList.push(makeWorker(() => (onmessage = (e) => console.log(e))));
    }
  };
</script>
