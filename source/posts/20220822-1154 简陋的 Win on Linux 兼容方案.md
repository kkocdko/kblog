```
title: 简陋的 Win on Linux 兼容方案
date: 2022.08.22 11:54
tags: Tutorial Linux Windows QEMU
description: （正在施工）
```

> **未完成，有空再写**
>
> 本文原先希望以教程形式展开，现在看来细节是讲不完了。打算把其中一些重要的内容提一下就完事。

## 概述

几乎每个 Linux 桌面用户都会有运行 Windows 程序的需求，对此的解决方案也是五花八门。本文的方案大致是：

- QEMU KVM + 精简版 Windows 10。
- 开启 Snapshot，避免写入原始镜像。
- 客户机内运行 WebDav 服务端进行文件共享。

对比 Wine：

- Wine 性能几乎无损失，甚至可通过 Proton 运行大型游戏；本方案图形性能较弱。
- 本方案较为通用，可在各种硬件、内核、发行版下运行；Wine 对环境要求较多。
- 本方案几乎无需维护，一劳永逸；Wine 有时需为特定应用作出调整，存在紧急情况下新应用无法运行的尴尬。

对比其他虚拟机：

- VitrualBox 图形性能略好，需额外加载内核模块，可能在内核升级后崩溃；本方案使用 KVM，CPU 性能较好，无需额外内核模块，更稳定。
- ESXi 综合性能较好，安装繁琐，硬件兼容性差，收费；本方案安装简便，硬件兼容性好，除 Windows 本身外完全开源。
- 本方案中 QCOW2 磁盘镜像支持 ZSTD 压缩，可大幅减小体积（当前为 1.47 GiB）。

## 成品

下载链接: [OneDrive](https://1drv.ms/u/s!AndLPYbx5v06kh_hMRzLhgoTqOvN) | [123 云盘](https://www.123pan.com/s/SfI0Vv-yDEhd) | [百度网盘](https://pan.baidu.com/s/1M0zD537bNU5i78pcIyYk_w) 。若无特殊需求，建议直接使用成品镜像。其中，`win10_xxx.qcow2` 是磁盘镜像主体，文件名后半段为 CRC32 校验值。`win10_share.iso` 是外置光盘镜像，包含 WebDav 服务端。当然，你也可以添加其他内容。

安装 QEMU KVM：

```sh
# Fedora
sudo dnf install qemu-kvm qemu-img
# Ubuntu
sudo apt install qemu-kvm qemu-utils
```

接下来写入并运行 `./win10(.sh)`：

```sh
#!/bin/bash
base_img=win10_xxx.qcow2
snapshot_img=win10_snapshot.qcow2
share_img=win10_share.iso
if [ ! -f $snapshot_img ]; then
  qemu-img create -q -F qcow2 -b $base_img -f qcow2 $snapshot_img
fi
# 使用 sudo，规避鼠标捕获异常等问题
sudo qemu-kvm \
  -machine q35 -cpu host,hv-relaxed,hv-vapic,hv-spinlocks=0x1fff,hv-vpindex,hv-time,hv-synic,hv-stimer \
  -m 1.5G -smp 2 \
  -drive file=$snapshot_img -cdrom $share_img \
  -nic user,hostfwd=tcp:127.0.0.1:9121-:5000
# 若需要更高分辨率
# -vga qxl
# 若需要音频支持
# -audiodev pa,id=pa,server=unix:${XDG_RUNTIME_DIR}/pulse/native -device ich9-intel-hda -device hda-duplex,audiodev=pa
```

启动之后使用任意 WebDAV 客户端进行连接，实现文件共享。nautilus 内置的那个就行，左侧栏 Other Locations > 底部 Connect to Server，填 `dav://127.0.0.1:9121/`。

<details>
<summary>详细信息（点击展开）</summary>

```
* 未激活。个人认为这不影响使用，且 KMS 激活存在过期的麻烦。
* 默认 Administrator 账户，禁用 UAC 等几乎所有安全相关功能。
* 注销后立刻自动登录，方便在外置光盘镜像中修改分辨率和缩放设置。
* 集成常用运行库和精简版输入法，不加入额外内容。建议将自定义内容写入外置光盘镜像。

----- 常见问题 -----
* 为什么使用中文版系统：因为国内许多软件在英文系统下会出 Bug。也许你可以使用 Tiny10 自己做一个。
* 为什么不使用 virt-manager：因为 QEMU 命令行更简短，更可控，而且我平时折腾用习惯了。你想用 virt-manager 也没问题，照着上边的参数填进去就行。

----- 更新日志 -----
* 20220904：修复输入法无法输入全角符号，修复IE主页破坏提示。

----- 集成内容 -----
* .NET Framework (2.0, 3.0, 3.5, 4.6) * (32, 64)
* MS Visual C++ Redist (2005, 2008, 2010, 2013, 2015-2022) * (32, 64)
* 搜狗五笔输入法 (支持拼音)

----- 鸣谢 -----
安装镜像: Windows 10 三杰版 LTSB 2016 SE http://wuyou.net/forum.php?mod=viewthread&tid=411792
输入法: 搜狗五笔输入法 v5.2 正式版 for All Windows http://wuyou.net/forum.php?mod=viewthread&tid=428671
WebDav 服务端: DUFS https://github.com/sigoden/dufs
参数优化: https://leduccc.medium.com/improving-the-performance-of-a-windows-10-guest-on-qemu-a5b3f54d9cf5
```

</details>

## 减小虚拟机磁盘镜像体积

当前网络上对减小镜像体积有许多过时甚至错误的内容，所以在这说道两句。下述内容中如非注明，都是指装有 Windows 系统的虚拟机磁盘镜像。

文件系统的设计非常复杂（正经点，别拿 tmpfs 说事）。若你写入多个文件再删除靠前的一个，那么磁盘上就会留下 hole；打开多个 fd 同时写入，可能产生碎片；为减少碎片，文件系统又会用各种姿势做 preallocation；为提升性能，可能会缓存一个写入队列，先规划一下再 commit... 磁盘镜像文件本质是在文件系统之上再造一个 user space 的文件系统：把原本直接写入硬盘的操作转化为写入镜像文件。

请一定**区分“收缩(_shrink_)”与“压缩(_compress_)”**。“收缩”是整理镜像，消除空洞、碎片、冗余数据；“压缩”则是将数据使用压缩算法进行处理。

收缩镜像最简单有效的方式是直接取出内容，再写入到新镜像中。于是我们直接复制所有文件（使用 Dism++ 等工具备份还原），再用 `qemu-img` 重写镜像：

```sh
qemu-img create -f qcow2 win10.qcow2 32G
# > 此时安装系统
mv win10.qcow2 win10.old.qcow2
qemu-img create -f qcow2 win10.qcow2 32G
# > 此时启动到 PE，拆分原镜像分区，备份到拆出的空闲分区，还原到新镜像的分区
rm win10.old.qcow2
# 如果你接下来还要压缩，那么这一步是多余的
# qemu-img convert -p -f qcow2 -O qcow2 -c win10.qcow2 win10-shrink.qcow2
```

许多教程推荐使用 Virtual Disk Precompactor 或 dd 撑满镜像，迫使文件系统腾出连续空间，但这类做法实际上非常糟糕：不仅需要写入大量数据，且通常不能同时 defrag，耗时长效果差。

对于压缩，若你在虚拟机内使用 NTFS 或 Btrfs 透明压缩，就会发现这毫无作用，因为它们会尽量减少搬运，使压缩后的数据分布依然是稀疏的。个人认为目前的最佳方案是在 QCOW2 上启用 ZSTD 压缩，兼顾速度与体积：

```sh
qemu-img convert -p -f qcow2 -O qcow2 -c -o compression_type=zstd,preallocation=off win10.qcow2 win10-zstd.qcow2
```

但这仅能压缩镜像已有内容，对新写入的内容依旧不作压缩。另外，QEMU 默认的 ZSTD 压缩配置是默认等级。由于这个镜像我们只需要读取，不需要频繁改动，所以可以 [修改 QCOW2 镜像的 ZSTD 压缩级别](/./post/202206112353)，尽力压到最小。

> snapshot

<details>
<summary> [ ----- 草稿 ----- ] </summary>

<!--

0. 目录，起源
1. 选型：比较方案，协议限制
2. 制作：配置选项，选择镜像，装载，调整缩放
3. 交互：文件共享，网络
4. 应用：常用软件与技巧，搜狗五笔输入法
5. 优化：快照，差分，减小镜像体积，纯净化

```sh
mkisofs -udf -o share.iso ./share # use udf to support long file name

qemu-img create -f qcow2 win10.qcow2 32G
qemu-img convert -p -f qcow2 -O qcow2 -c -o compression_type=zstd,preallocation=off win10.qcow2 win10-zstd.qcow2
qemu-img create -q -F qcow2 -b win10.qcow2 -f qcow2 snapshot.qcow2

qemu-kvm -cdrom /run/media/kkocdko/data/win/pkgs/WinPE/WePE_2.2_10-64.iso -drive file=win10.qcow2 -drive file=share.iso,media=cdrom -boot order=d -m 1.5G -cpu host -accel kvm -smp 2

qemu-kvm -drive file=win10.qcow2 -m 2G -cpu host -accel kvm -smp 4

sudo qemu-kvm -cdrom /run/media/kkocdko/data/win/pkgs/WinPE/WePE_2.2_10-64.iso -drive file=./win10.qcow2 -drive file=./win10_snapshot.qcow2 -drive file=./share.qcow2 -boot order=d -m 1.5G -smp 2 -cpu host -accel kvm

删除显示器设置： # HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\GraphicsDrivers\Configuration\MSBDD...
自动启动挂载光盘中的 batch
ide channel limit, if too many cdrom mount ,error
```

```
# dump from virt-manager
[kkocdko@fedora apps]$ ps -aux | grep qemu
kkocdko    12322  0.1  0.2 1453884 39248 ?       Sl   22:45   0:07 /usr/sbin/virtqemud --timeout=120
kkocdko    15609  118 13.8 3683748 2179736 ?     Rl   23:48   0:11 /usr/bin/qemu-system-x86_64 -name guest=win10,debug-threads=on -S -object {"qom-type":"secret","id":"masterKey0","format":"raw","file":"/home/kkocdko/.config/libvirt/qemu/lib/domain-15-win10/master-key.aes"} -machine pc-q35-6.2,usb=off,vmport=off,dump-guest-core=off,memory-backend=pc.ram -accel kvm -cpu host,migratable=off,hv-time=on,hv-relaxed=on,hv-vapic=on,hv-spinlocks=0x1fff,hv-vpindex=on,hv-synic=on,hv-stimer=on,hv-reset=on -m 2048 -object {"qom-type":"memory-backend-ram","id":"pc.ram","size":2147483648} -overcommit mem-lock=off -smp 4,sockets=1,dies=1,cores=2,threads=2 -uuid ce00fddb-b8bf-4838-b6ea-a4bd13c02a54 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=28,server=on,wait=off -mon chardev=charmonitor,id=monitor,mode=control -rtc base=localtime,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=16,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=17,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=18,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=19,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=20,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=21,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=22,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=23,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device pcie-root-port,port=24,chassis=9,id=pci.9,bus=pcie.0,multifunction=on,addr=0x3 -device pcie-root-port,port=25,chassis=10,id=pci.10,bus=pcie.0,addr=0x3.0x1 -device pcie-root-port,port=26,chassis=11,id=pci.11,bus=pcie.0,addr=0x3.0x2 -device pcie-root-port,port=27,chassis=12,id=pci.12,bus=pcie.0,addr=0x3.0x3 -device pcie-root-port,port=28,chassis=13,id=pci.13,bus=pcie.0,addr=0x3.0x4 -device pcie-root-port,port=29,chassis=14,id=pci.14,bus=pcie.0,addr=0x3.0x5 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.2,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.3,addr=0x0 -blockdev {"driver":"file","filename":"/tmp/win10_snapshot.qcow2","node-name":"libvirt-1-storage","auto-read-only":true,"discard":"unmap"} -blockdev {"node-name":"libvirt-1-format","read-only":false,"driver":"qcow2","file":"libvirt-1-storage","backing":null} -device ide-hd,bus=ide.1,drive=libvirt-1-format,id=sata0-0-1,bootindex=1 -netdev user,id=hostnet0 -device e1000e,netdev=hostnet0,id=net0,mac=52:54:00:95:ef:65,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0,index=0 -chardev spicevmc,id=charchannel0,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=com.redhat.spice.0 -device usb-tablet,id=input0,bus=usb.0,port=1 -audiodev {"id":"audio1","driver":"spice"} -spice port=5900,addr=127.0.0.1,disable-ticketing=on,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,max_outputs=1,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,bus=pcie.0,addr=0x1 -device ich9-intel-hda,id=sound0,bus=pcie.0,addr=0x1b -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0,audiodev=audio1 -device virtio-balloon-pci,id=balloon0,bus=pci.4,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on
kkocdko    15646  0.0  0.0 222300  2128 pts/3    S+   23:48   0:00 grep --color=auto qemu
```

https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/dpi-related-apis-and-registry-settings

| Scale | DPI | DPI (Hex) | Name        |
| ----- | --- | --------- | ----------- |
| 100 % | 96  | 0x0060    | default     |
| 125 % | 120 | 0x0078    | medium      |
| 150 % | 144 | 0x0090    | larger      |
| 200 % | 192 | 0x00c0    | extra-large |

```
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
"DefaultUserName"="Administrator"
"DefaultPassword"=""
"AutoAdminLogon"="1"
"ForceAutoLogon"=dword:00000001
"ForceUnlockLogon"=dword:00000001

[HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Serialize]
"StartupDelayInMSec"=dword:00000000
```

-->

</details>
