```
title: 简陋的 Win on Linux 兼容方案
date: 2022.08.22 11:54
tags: Tutorial Linux Windows QEMU
description: （正在施工）
```

## **未完成，有空再写**

## 概述

几乎每一个桌面端 Linux 用户都会有运行 Windows 程序的需求，对于这一需求的解决方案也是五花八门。本文的方案大致是：

- QEMU KVM + 精简版 Windows 10。
- 使用时开启 Snapshot 避免写入原始镜像。
- 客户机内运行 WebDav 服务端进行文件共享。

对比 Wine：

- Wine 几乎不占用额外内存；本方案需占用固定大小内存。
- Wine 图形性能强，甚至可通过 Proton 运行大型游戏；本方案图形性能较弱。
- 本方案较为通用，可在各种硬件、内核、发行版下运行；Wine 对环境要求较多。
- 本方案兼容性完美；Wine 近年兼容性有极大改善，但始终有缺陷。
- 本方案几乎无需维护，一劳永逸；Wine 有时需针对特定应用调整配置，存在紧急情况下需使用新应用却无法运行的尴尬。

对比其他虚拟机：

- VitrualBox 图形性能略好，需额外加载内核模块，可能在内核升级后崩溃；本方案使用 KVM，CPU 性能较好，无需额外内核模块，更稳定。
- ESXi 性能较好，安装繁琐，硬件兼容性差，收费；本方案安装简便，硬件兼容性好，除 Windows 本身外完全开源。
- 本方案中 QEMU 的 QCOW2 磁盘镜像支持 ZSTD 压缩，可大幅减少磁盘占用。

## 成品

建议直接使用成品镜像。下载链接: [OneDrive](https://1drv.ms/u/s!AndLPYbx5v06kh_hMRzLhgoTqOvN) | [123 云盘](https://www.123pan.com/s/SfI0Vv-yDEhd) | [百度网盘](https://pan.baidu.com/s/1M0zD537bNU5i78pcIyYk_w) 。

其中，`win10_xxx.qcow2` 是磁盘镜像主体，文件名后半段为 CRC32 校验值。`win10_share.iso` 是外置光盘镜像，包含 WebDav 服务端。当然，你也可以添加其他内容。

安装 QEMU KVM：

```sh
# Fedora
sudo dnf install qemu-kvm qemu-img
# Ubuntu
sudo apt install qemu-kvm qemu-img
```

接下来，只需执行以下命令：

```sh
#!/bin/bash
base_img=win10_xxx.qcow2
snapshot_img=win10_snapshot.qcow2
share_img=win10_share.iso
chmod -w $base_img # 确保不写入原始镜像
if [ ! -f $snapshot_img ]; then
  qemu-img create -q -F qcow2 -b $base_img -f qcow2 $snapshot_img
fi
sudo qemu-kvm \ # 若不使用 sudo，可能出现鼠标捕获异常等问题
  -drive file=$snapshot_img -cdrom $share_img \
  -m 1.5G -smp 2 -cpu host -accel kvm \ # 自行调整配置
  -nic user,hostfwd=tcp:127.0.0.1:9121-:5000 # WebDAV
# 如果需要更高分辨率，可以使用 -vga qxl -device qxl
```

<details>
<summary> [ ----- 草稿 ----- ] </summary>

关于镜像：

```
* 没有激活。个人认为未激活不影响使用。
* 默认 Administrator 账户，禁用 UAC 等几乎所有安全相关功能。
* 注销后立刻自动登录，方便在外置光盘镜像中修改分辨率和缩放设置。
* 集成常用运行库和精简版输入法，不加入额外内容。建议将自定义内容写入外置光盘镜像。

----- 集成内容 -----
.NET Framework (32, 64) * (2.0, 3.0, 3.5, 4.6)
MS Visual C++ Redist (32, 64) * (2005, 2008, 2010, 2013, 2015-2022)
搜狗五笔输入法 (支持拼音)

----- 来源信息 -----
安装镜像: Windows 10 三杰版 LTSB 2016 SE http://wuyou.net/forum.php?mod=viewthread&tid=411792
输入法: 搜狗五笔输入法 v5.2 正式版 for All Windows http://wuyou.net/forum.php?mod=viewthread&tid=428671
WebDav 服务端: DUFS https://github.com/sigoden/dufs
```

```sh
#!/bin/bash

# ensure run as root
if [[ $EUID -ne 0 ]]; then
  sudo $0 $*
  exit
fi

base_img=/run/media/kkocdko/data/win/pkgs/sys-imgs/win10_4006825f.qcow2
share_img=/run/media/kkocdko/data/win/pkgs/sys-imgs/win10_share.iso
tmpfs_dir=/home/kkocdko/misc/tmpfs
snapshot_img=$tmpfs_dir/win10_snapshot.qcow2
if [ ! -d $tmpfs_dir ]; then
  /home/kkocdko/misc/apps/ramdisk
fi
if [ ! -f $snapshot_img ]; then
  qemu-img create -f qcow2 -b $base_img -F qcow2 -o compression_type=zstd $snapshot_img &> /dev/null
  echo a new qemu snapshot image was created
fi
# use sudo, weaken the input grab
sudo qemu-kvm -drive file=$snapshot_img -cdrom $share_img -m 1.5G -cpu host -accel kvm -smp 2 -nic user,hostfwd=tcp:127.0.0.1:9121-:5000
# -vga qxl -device qxl
```

本页是《 LSW - 简陋的 Linux 上的 Win 兼容方案 》的目录。各篇链接如下：

0. 目录，起源

1. 选型：比较方案，协议限制

2. 制作：配置选项，选择镜像，装载，调整缩放

3. 交互：文件共享，网络

4. 应用：常用软件与技巧，搜狗五笔输入法

5. 优化：快照，差分，减小镜像体积，纯净化

```sh
# use udf to support long file name
mkisofs -udf -o share.iso ./share
qemu-img create -f qcow2 -o compression_type=zstd,preallocation=off win10.qcow2 32G
qemu-kvm -cdrom /run/media/kkocdko/data/win/pkgs/WinPE/WePE_2.2_10-64.iso -drive file=win10.qcow2 -drive file=share.iso,media=cdrom -boot once=d -m 1.5G -cpu host -accel kvm -smp 2
qemu-img convert -p -f qcow2 -O qcow2 -c -o compression_type=zstd,preallocation=off win10.qcow2 win10-zstd.qcow2
qemu-kvm -drive file=win10.qcow2 -m 1.5G -cpu host -accel kvm -smp 2

qemu-img create -f qcow2 -b win10_71c68d8d.qcow2 -F qcow2 -o compression_type=zstd snapshot.qcow2

qemu-kvm -cdrom /run/media/kkocdko/data/win/pkgs/WinPE/WePE_2.2_10-64.iso -drive file=/run/media/kkocdko/data/win/pkgs/sys-imgs/win10_22b7d436.qcow2 -boot once=d -m 2G -cpu host -accel kvm -smp 4

sudo qemu-kvm -cdrom /run/media/kkocdko/data/win/pkgs/WinPE/WePE_2.2_10-64.iso -drive file=/run/media/kkocdko/data/win/pkgs/sys-imgs/win10_22b7d436.qcow2 -drive file=/home/kkocdko/misc/reg/share.iso,media=cdrom -boot once=d -m 2G -cpu host -accel kvm -smp 4

sudo qemu-kvm -cdrom /run/media/kkocdko/data/win/pkgs/WinPE/WePE_2.2_10-64.iso -drive file=win10.qcow2 -drive file=win10_old.qcow2 -boot once=d -m 2G -cpu host -accel kvm -smp 4

删除显示器设置： # HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\GraphicsDrivers\Configuration\MSBDD...
自动启动挂载光盘中的 batch

sudo qemu-kvm -drive file=win10.qcow2 -m 2G -cpu host -accel kvm -smp 4


ide channel limit, if too many cdrom mount ,error

```

| Scale | DPI | DPI (Hex) | Name        |
| ----- | --- | --------- | ----------- |
| 100 % | 96  | 0x0060    | default     |
| 125 % | 120 | 0x0078    | medium      |
| 150 % | 144 | 0x0090    | larger      |
| 200 % | 192 | 0x00c0    | extra-large |
| 250 % | 240 | 0x00f0    | custom      |
| 300 % | 288 | 0x0120    | custom      |
| 400 % | 384 | 0x0180    | custom      |
| 500 % | 480 | 0x01e0    | custom      |

```
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
"DefaultUserName"="Administrator"
"DefaultPassword"=""
"AutoAdminLogon"="1"
"ForceAutoLogon"=dword:00000001
"ForceUnlockLogon"=dword:00000001

[HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Serialize]
"StartupDelayInMSec"=dword:00000000
```

https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/dpi-related-apis-and-registry-settings

最近在尝试努力弄出一个方便的 Win10 镜像，在 QEMU 中运行，以满足我偶尔的使用 Windows 的需求。我希望让这个镜像足够小，只读，并且让

1. 请区分“收缩”和“压缩”的区别。不能混为一谈。

2. 在磁盘镜像中写入文件，镜像会被“撑开”。删除了文件后，要想让镜像回到原本的大小，需要“收缩”镜像。

3. 不要使用 Virtual Disk Precompactor，直接复制并修复引导。最好是单线程，减少碎片。

4. `NTFS` 压缩 无效

5. QEMU 的 `qcow2`

6. snapshot

</details>
